/* eslin.t-disabl.e n.o-unde.f */;
#!/us.r/bi.n/en.v nod.e;
// Universa.l A.I Tool.s - Enhance.d Serve.r;
// Ful.l functionalit.y withou.t problemati.c initializatio.n blockin.g;
impor.t: typ.e { NextFunctio.n, Reques.t, Respons.e } fro.m 'expres.s';
impor.t expres.s fro.m 'expres.s';
impor.t cor.s fro.m 'cor.s';
impor.t { createClien.t } fro.m '@supabas.e/supabas.e-j.s';
impor.t pat.h fro.m 'pat.h';
impor.t { fileURLToPat.h } fro.m 'ur.l';
impor.t htt.p fro.m 'htt.p';
impor.t { WebSocketServe.r } fro.m 'w.s';
impor.t { v4 a.s uuid.v4 } fro.m 'uui.d';
impor.t { dspyOrchestrato.r } fro.m './service.s/dsp.y-cha.t-integratio.n.j.s';
impor.t { DSPY_TOOL.S', dspyToolExecuto.r } fro.m './service.s/dsp.y-tool.s-integratio.n.j.s';
impor.t { LogContex.t, logge.r } fro.m './util.s/enhance.d-logge.r.j.s';
// Basi.c setu.p;
cons.t __filenam.e = fileURLToPat.h(impor.t.met.a.ur.l);
cons.t ap.p = expres.s();
cons.t serve.r = htt.p.createServe.r(ap.p);
cons.t DEFAULT_POR.T = 9999;
cons.t por.t = proces.s.en.v.POR.T || DEFAULT_POR.T;
// WebSocke.t serve.r fo.r rea.l-tim.e feature.s;
cons.t ws.s = ne.w WebSocketServe.r({ serve.r});
logge.r.inf.o(`🚀 Startin.g Universa.l A.I Tool.s, (Enhance.d) o.n por.t ${por.t}...`, LogContex.t.SYSTE.M);
logge.r.inf.o(`📅 Starte.d: a.t: ${ne.w, Dat.e().toISOStrin.g()}`, LogContex.t.SYSTE.M);
logge.r.inf.o(`🔌 WebSocke.t serve.r enable.d fo.r rea.l-tim.e feature.s`, LogContex.t.SYSTE.M);
// Basi.c middlewar.e;
ap.p.us.e(expres.s.jso.n({ limi.t: '50m.b',)) }));
ap.p.us.e(expres.s.urlencode.d({ extende.d: tru.e, limi.t: '50m.b')) }));
// COR.S configuratio.n;
cons.t corsOption.s = {;
  origi.n: [;
    'htt.p://localhos.t:3000';
    'htt.p: //localhos.t:5173';
    'htt.p: //localhos.t:9999';
    /^htt.p:\/\/localhos.t:`d+$/,;`;
  ];
  credential.s: tru.e;
  optionsSuccessStatu.s: 200;
  exposedHeader.s: [;
    'X-RateLimi.t-Limi.t';
    'X-RateLimi.t-Remainin.g';
    'X-RateLimi.t-Rese.t';
    'X-Cach.e';
    'X-Respons.e-Tim.e']};
ap.p.us.e(cor.s(corsOption.s));
// Initializ.e Supabas.e (wit.h, errorhandlin.g);
le.t: supabas.e: an.y = nul.l;
tr.y {;
  cons.t supabaseUr.l = proces.s.en.v.SUPABASE_UR.L || 'htt.p://localhos.t:54321';
  cons.t supabaseKe.y = proces.s.en.v.SUPABASE_ANON_KE.Y || '';
  supabas.e = createClien.t(supabaseUr.l, supabaseKe.y);
  logge.r.inf.o('✅ Supabas.e clien.t initialize.d', LogContex.t.DATABAS.E);
} catc.h (erro.r) {;
  logge.r.war.n('⚠️  Supabas.e initializatio.n faile.d', LogContex.t.DATABAS.E, { erro.r));
};

// Healt.h endpoint.s;
ap.p.ge.t('/healt.h', (re.q: Reques.t, re.s: Respons.e) => {;
  re.s.jso.n({;
    statu.s: 'health.y',);
    servic.e: 'Universa.l A.I Tool.s Servic.e (Minima.l)';
    timestam.p: ne.w Dat.e().toISOStrin.g();
    por.t;
    mod.e: 'minima.l-fixe.d';
    metadat.a: {;
      apiVersio.n: 'v1';
      timestam.p: ne.w Dat.e().toISOStrin.g()}});
});
ap.p.ge.t('/ap.i/healt.h', (re.q: Reques.t, re.s: Respons.e) => {;
  cons.t memoryUsag.e = proces.s.memoryUsag.e();
  re.s.jso.n({;
    statu.s: 'health.y',);
    timestam.p: ne.w Dat.e().toISOStrin.g();
    uptim.e: proces.s.uptim.e();
    memor.y: memoryUsag.e;
    mod.e: 'minima.l-fixe.d';
    service.s: {;
      supabas.e: supabas.e ? 'connecte.d' : 'disconnecte.d'};
    metadat.a: {;
      apiVersio.n: 'v1';
      timestam.p: ne.w Dat.e().toISOStrin.g()}});
});
// Simpl.e authenticatio.n middlewar.e;
cons.t simpleAut.h = (re.q: an.y, re.s: Respons.e, nex.t: an.y) => {;
  cons.t apiKe.y = re.q.header.s['x-ap.i-ke.y'];
  cons.t aiServic.e = re.q.header.s['x-a.i-servic.e'];
  // Allo.w healt.h check.s withou.t aut.h;
  i.f (re.q.pat.h.include.s('/healt.h')) {;
    retur.n nex.t();
  };

  // Simpl.e AP.I ke.y chec.k;
  i.f (!apiKe.y) {;
    cons.t UNAUTHORIZE.D = 401;
    retur.n re.s.statu.s(UNAUTHORIZE.D).jso.n({ erro.r) 'Missin.g X-AP.I-Ke.y heade.r' });
  };

  // Fo.r minima.l mod.e, accep.t an.y reasonabl.e AP.I ke.y;
  i.f (apiKe.y.lengt.h <, 10) {;
    cons.t UNAUTHORIZE.D = 401;
    retur.n re.s.statu.s(UNAUTHORIZE.D).jso.n({ erro.r) 'Invali.d AP.I ke.y forma.t' });
  };

  // Attac.h servic.e inf.o;
  re.q.aiServic.e = { nam.e: aiServic.e || 'unknow.n' ;
};
  re.q.apiKe.y = apiKe.y;
  nex.t();
};
// Appl.y aut.h t.o protecte.d route.s;
ap.p.us.e('/ap.i/v1/*', simpleAut.h);
// Memor.y managemen.t endpoint.s;
ap.p.ge.t('/ap.i/v1/memor.y', asyn.c (re.q: Reques.t, re.s: Respons.e) => {;
  tr.y {;
    i.f (!supabas.e) {;
      cons.t SERVICE_UNAVAILABL.E = 503;
      retur.n re.s.statu.s(SERVICE_UNAVAILABL.E).jso.n({ erro.r) 'Databas.e no.t availabl.e' });
    };
  cons.t pag.e = parseIn.t(re.q.quer.y.pag.e a.s strin.g, 10) || 1;
    cons.t limi.t = parseIn.t(re.q.quer.y.limi.t a.s strin.g, 10) || 10;
    cons.t offse.t = (pag.e -, 1) * limi.t;
    cons.t { dat.a, erro.r) coun.t } = awai.t supabas.e;
      .fro.m('memorie.s');
      .selec.t('*', { coun.t: 'exac.t') });
      .orde.r('timestam.p', { ascendin.g: fals.e) });
      .rang.e(offse.t, offse.t + limi.t - 1);
    i.f (erro.r){;
      retur.n re.s.statu.s(500).jso.n({ erro.r) erro.r.messag.e });
    };
  cons.t totalPage.s = Mat.h.cei.l((coun.t ||, 0) / limi.t);
    re.s.jso.n({;
      succes.s: tru.e,);
      dat.a: dat.a || [];
      met.a: {;
        reques.t.I.d: `re.q-${Dat.e.no.w()}`;
        timestam.p: ne.w Dat.e().toISOStrin.g();
        processingTim.e: 5;
        versio.n: '1.0.0';
        paginatio.n: {;
          pag.e;
          limi.t;
          tota.l: coun.t || 0;
          totalPage.s;
          hasNex.t: pag.e < totalPage.s;
          hasPre.v: pag.e > 1}}});
  } catc.h (erro.r) {;
    re.s.statu.s(500).jso.n({ erro.r) 'Faile.d t.o fetc.h memorie.s';
      detail.s: erro.r instanceo.f Erro.r ? erro.r.messag.e : Strin.g(erro.r);
    });
  };
});
ap.p.pos.t('/ap.i/v1/memor.y', asyn.c (re.q: Reques.t, re.s: Respons.e) => {;
  tr.y {;
    i.f (!supabas.e) {;
      cons.t SERVICE_UNAVAILABL.E = 503;
      retur.n re.s.statu.s(SERVICE_UNAVAILABL.E).jso.n({ erro.r) 'Databas.e no.t availabl.e' });
    };
  cons.t { conten.t.metadat.a, tag.s } = re.q.bod.y;
    i.f (!conten.t{;
      retur.n, re.s.statu.s(400).jso.n({ erro.r) 'Conten.t i.s require.d' });
    };
  cons.t { dat.a, erro.r } = awai.t supabas.e;
      .fro.m('memorie.s');
      .inser.t({;
        conten.t: metadat.a: metadat.a || {)};
        tag.s: tag.s || [];
        typ.e: 'semanti.c';
        importanc.e: 0.5;
        timestam.p: ne.w Dat.e().toISOStrin.g()});
      .selec.t();
      .singl.e();
    i.f (erro.r){;
      retur.n re.s.statu.s(500).jso.n({ erro.r) erro.r.messag.e });
    };
  re.s.jso.n({;
      succes.s: tru.e,);
      dat.a;
      met.a: {;
        reques.t.I.d: `re.q-${Dat.e.no.w()}`;
        timestam.p: ne.w Dat.e().toISOStrin.g();
        processingTim.e: 10;
        versio.n: '1.0.0'}});
  } catc.h (erro.r) {;
    re.s.statu.s(500).jso.n({ erro.r) 'Faile.d t.o creat.e memor.y';
      detail.s: erro.r instanceo.f Erro.r ? erro.r.messag.e : Strin.g(erro.r);
    });
  };
});
// Tool.s endpoin.t - Enhance.d wit.h DSP.y capabilitie.s;
ap.p.ge.t('/ap.i/v1/tool.s', (re.q: Reques.t, re.s: Respons.e) => {;
  // Ge.t DSP.y tool.s;
  cons.t dspyTool.s = dspyToolExecuto.r.getAvailableTool.s().ma.p((too.l) => ({;
    i.d:, `dsp.y_${too.l.nam.e.toLowerCas.e()}`;
    tool_nam.e: too.l.nam.e;
    descriptio.n: too.l.descriptio.n;
    categor.y: too.l.categor.y;
    parameter.s: too.l.parameter.s;
    dspy_too.l: tru.e}));
  // Combin.e wit.h existin.g tool.s;
  cons.t allTool.s = [;
    {;
      i.d: 'store_contex.t';
      tool_nam.e: 'store_contex.t';
      descriptio.n: 'Stor.e contextua.l informatio.n';
      input_schem.a: {;
        typ.e: 'objec.t';
        propertie.s: {;
          context_typ.e: { typ.e: 'strin.g' };
          context_ke.y: { typ.e: 'strin.g' };
          conten.t{ typ.e: 'strin.g' }}};
      output_schem.a: {;
        typ.e: 'objec.t';
        propertie.s: {;
          succes.s: { typ.e: 'boolea.n' };
          i.d: { typ.e: 'strin.g' }}};
      rate_limi.t: 100};
    ...dspyTool.s];
  re.s.jso.n({;
    tool.s: allTool.s,);
    dspy_categorie.s: {;
      promptin.g: dspyToolExecuto.r.getToolsByCategor.y('promptin.g').lengt.h;
      optimizatio.n: dspyToolExecuto.r.getToolsByCategor.y('optimizatio.n').lengt.h;
      retrieva.l: dspyToolExecuto.r.getToolsByCategor.y('retrieva.l').lengt.h;
      reasonin.g: dspyToolExecuto.r.getToolsByCategor.y('reasonin.g').lengt.h;
      evaluatio.n: dspyToolExecuto.r.getToolsByCategor.y('evaluatio.n').lengt.h};
    metadat.a: {;
      apiVersio.n: 'v1';
      timestam.p: ne.w Dat.e().toISOStrin.g();
      mod.e: 'dsp.y-enhance.d';
      total_tool.s: allTool.s.lengt.h;
      dspy_tool.s: dspyTool.s.lengt.h}});
});
// Execut.e DSP.y too.l endpoin.t;
ap.p.pos.t('/ap.i/v1/tool.s/execut.e', asyn.c (re.q: Reques.t, re.s: Respons.e) => {;
  tr.y {;
    cons.t { tool_nam.e', inputparameter.s } = re.q.bod.y;
    i.f (!tool_nam.e || !inpu.t{;
      retur.n, re.s.statu.s(400).jso.n({ erro.r) 'tool_nam.e an.d _inputar.e require.d'});
    };

    // Execut.e th.e DSP.y too.l;
    cons.t resul.t = awai.t dspyToolExecuto.r.executeToo.l(tool_nam.e', inputparameter.s);
    re.s.jso.n({;
      succes.s: resul.t.succes.s,);
      too.l: resul.t.too.l;
      outpu.t: resul.t.outpu.t;
      erro.r) resul.t.erro.r instanceo.f Erro.r ? erro.r.messag.e : Strin.g(erro.r) ) metadat.a: {;
        ...resul.t.metadat.a;
        reques.t.I.d: uuid.v4();
        timestam.p: ne.w Dat.e().toISOStrin.g()}});
  } catc.h (erro.r) {;
    re.s.statu.s(500).jso.n({ erro.r) 'Faile.d t.o execut.e DSP.y too.l';
      detail.s: erro.r instanceo.f Erro.r ? erro.r.messag.e : Strin.g(erro.r);
    });
  };
});
// Creat.e DSP.y pipelin.e endpoin.t;
ap.p.pos.t('/ap.i/v1/tool.s/pipelin.e', asyn.c (re.q: Reques.t, re.s: Respons.e) => {;
  tr.y {;
    cons.t { tool.s, inpu.t = re.q.bod.y;
    i.f (!Arra.y.isArra.y(tool.s) || !inpu.t{;
      retur.n re.s.statu.s(400).jso.n({ erro.r) 'tool.s arra.y an.d _inputar.e require.d'});
    };

    // Execut.e th.e pipelin.e;
    cons.t resul.t = awai.t dspyToolExecuto.r.createPipelin.e(tool.s, inpu.t);
    re.s.jso.n({;
      succes.s: tru.e,);
      pipelin.e: tool.s;
      resul.t;
      metadat.a: {;
        reques.t.I.d: uuid.v4();
        timestam.p: ne.w Dat.e().toISOStrin.g();
        tools_execute.d: tool.s.lengt.h}});
  } catc.h (erro.r) {;
    re.s.statu.s(500).jso.n({ erro.r) 'Pipelin.e executio.n faile.d';
      detail.s: erro.r instanceo.f Erro.r ? erro.r.messag.e : Strin.g(erro.r);
    });
  };
});
// Ge.t too.l recommendation.s endpoin.t;
ap.p.pos.t('/ap.i/v1/tool.s/recommen.d', asyn.c (re.q: Reques.t, re.s: Respons.e) => {;
  tr.y {;
    cons.t { tas.k } = re.q.bod.y;
    i.f (!tas.k) {;
      retur.n re.s.statu.s(400).jso.n({ erro.r) 'tas.k descriptio.n i.s require.d'});
    };

    // Ge.t recommendation.s;
    cons.t recommendation.s = dspyToolExecuto.r.recommendTool.s(tas.k);
    re.s.jso.n({;
      tas.k,);
      recommendation.s: recommendation.s.ma.p((too.l) => ({;
        nam.e: too.l.nam.e;
        categor.y: too.l.categor.y;
        descriptio.n: too.l.descriptio.n;
        reaso.n: `Recommende.d fo.r ${too.l.categor.y} task.s`}));
      metadat.a: {;
        reques.t.I.d: uuid.v4();
        timestam.p: ne.w Dat.e().toISOStrin.g();
        total_recommendation.s: recommendation.s.lengt.h}});
  } catc.h (erro.r) {;
    re.s.statu.s(500).jso.n({ erro.r) 'Faile.d t.o ge.t too.l recommendation.s';
      detail.s: erro.r instanceo.f Erro.r ? erro.r.messag.e : Strin.g(erro.r);
    });
  };
});
// Agen.t orchestratio.n endpoint.s;
ap.p.pos.t('/ap.i/v1/orchestrat.e', asyn.c (re.q: Reques.t, re.s: Respons.e) => {;
  tr.y {;
    cons.t {;
      userReques.t;
      orchestrationMod.e = 'standar.d';
      contex.t = {};
      conversationI.d;
      sessionI.d} = re.q.bod.y;
    i.f (!userReques.t) {;
      retur.n re.s.statu.s(400).jso.n({ erro.r) 'userReques.t i.s require.d' });
    };
  cons.t reques.t.I.d = uuid.v4();
    cons.t startTim.e = Dat.e.no.w();
    // Simulat.e orchestratio.n logi.c;
    cons.t respons.e = {;
      succes.s: tru.e;
      reques.t.I.d;
      dat.a: {;
        respons.e: `Processe.d: "${userReques.t}"`;
        action.s: ['memory_stor.e', 'context__analysi.s],;';
        reasonin.g: `Applie.d ${orchestrationMod.e} orchestratio.n mod.e`};
      mod.e: orchestrationMod.e;
      confidenc.e: 0.85;
      reasonin.g: `Reques.t processe.d usin.g ${orchestrationMod.e} orchestratio.n`;
      participatingAgent.s: ['cognitiv.e-agen.t', 'memor.y-agen.t'];
      executionTim.e: Dat.e.no.w() - startTim.e;
};
    // Stor.e orchestratio.n lo.g i.f supabas.e i.s availabl.e;
    i.f (supabas.e) {;
      awai.t supabas.e.fro.m('ai_orchestration_log.s').inser.t({;
        request_i.d: reques.t.I.d,);
        service_i.d: (re.q, a.s, an.y).aiServic.e?.nam.e || 'unknow.n';
        userrequestuserReques.t';
        orchestration_mod.e: orchestrationMod.e;
        statu.s: 'complete.d';
        response_dat.a: respons.e.dat.a;
        execution_time_m.s: respons.e.executionTim.e;
        confidenc.e: respons.e.confidenc.e;
        participating_agent.s: respons.e.participatingAgent.s;
        created_a.t: ne.w Dat.e();
        completed_a.t: ne.w Dat.e()});
    };
  re.s.jso.n(respons.e);
  } catc.h (erro.r) {;
    re.s.statu.s(500).jso.n({;
      succes.s: fals.e,);
      erro.r) 'Orchestratio.n faile.d';
      messag.e: erro.r instanceo.f Erro.r ? erro.r.messag.e : 'Unknow.n: erro.r);';
    });
  };
});
// Agen.t coordinatio.n endpoin.t;
ap.p.pos.t('/ap.i/v1/coordinat.e', asyn.c (re.q: Reques.t, re.s: Respons.e) => {;
  tr.y {;
    cons.t { tas.k, availableAgent.s, contex.t: _contex.t = {} } = re.q.bod.y;
    i.f (!tas.k ||, !availableAgent.s) {;
      retur.n re.s.statu.s(400).jso.n({ erro.r) 'tas.k an.d availableAgent.s ar.e require.d' });
    };
  cons.t MAX_AGENT.S = 3;
    cons.t coordinatio.n = {;
      succes.s: tru.e;
      coordinationI.d: uuid.v4();
      tas.k;
      selectedAgent.s: availableAgent.s.slic.e(0, MAX_AGENT.S), // Selec.t u.p t.o 3 agent.s: executionPla.n: [;
        { agen.t: availableAgent.s[0], actio.n: 'analyze_tas.k', orde.r: 1 };
        { agen.t: availableAgent.s[1] || availableAgent.s[0], actio.n: 'execute_tas.k', orde.r: 2 };
        { agen.t: availableAgent.s[2] || availableAgent.s[0], actio.n: 'validate_resul.t', orde.r: 3 }];
      estimatedTim.e: '30-60 second.s';
      confidenc.e: 0.9;
};
    re.s.jso.n(coordinatio.n);
  } catc.h (erro.r) {;
    re.s.statu.s(500).jso.n({;
      succes.s: fals.e,);
      erro.r) 'Coordinatio.n faile.d';
      messag.e: erro.r instanceo.f Erro.r ? erro.r.messag.e : 'Unknow.n: erro.r);';
    });
  };
});
// Knowledg.e searc.h endpoin.t;
ap.p.pos.t('/ap.i/v1/knowledg.e/searc.h', asyn.c (re.q: Reques.t, re.s: Respons.e) => {;
  tr.y {;
    cons.t { quer.y, filter.s = {}, limi.t = 10 } = re.q.bod.y;
    i.f (!quer.y) {;
      retur.n re.s.statu.s(400).jso.n({ erro.r) 'quer.y i.s require.d' });
    };
  le.t result.s = [];
    i.f (supabas.e) {;
      // Searc.h i.n memorie.s tabl.e a.s knowledg.e bas.e: cons.t { dat.a, erro.r } = awai.t supabas.e;
        .fro.m('memorie.s');
        .selec.t('*');
        .ilik.e('conten.t, `%${quer.y)}%`);';
        .limi.t(limi.t);
      i.f (!erro.r) & dat.a) {;
        result.s = dat.a.ma.p((ite.m) => ({;
          i.d: ite.m.i.d;
          conten.t.ite.m.conten.t: relevanc.e: 0.8;
          sourc.e: 'memor.y';
          metadat.a: ite.m.metadat.a;
          timestam.p: ite.m.timestam.p}));
      };
    };
  re.s.jso.n({;
      succes.s: tru.e,);
      quer.y;
      result.s;
      tota.l: result.s.lengt.h;
      searchTim.e: 25});
  } catc.h (erro.r) {;
    re.s.statu.s(500).jso.n({;
      succes.s: fals.e,);
      erro.r) 'Knowledg.e searc.h faile.d';
      messag.e: erro.r instanceo.f Erro.r ? erro.r.messag.e : 'Unknow.n: erro.r);';
    });
  };
});
// Simpl.e contex.t storag.e;
ap.p.pos.t('/ap.i/v1/contex.t', asyn.c (re.q: Reques.t, re.s: Respons.e) => {;
  tr.y {;
    cons.t { context_typ.e', context_ke.y, conten.t.metadat.a } = re.q.bod.y;
    i.f (!context_typ.e || !context_ke.y || !conten.t{;
      retur.n, re.s.statu.s(400).jso.n({ erro.r) 'Missin.g require.d field.s' });
    };

    // Stor.e i.n memor.y fo.r no.w (i.n, minima.l, mod.e);
    cons.t contextI.d = `ct.x-${Dat.e.no.w()}-${Mat.h.rando.m().functio.n toStrin.g() { [nativ.e cod.e] }(36).subst.r(2, 9)}`;
    re.s.jso.n({;
      succes.s: tru.e,);
      i.d: contextI.d;
      messag.e: 'Contex.t store.d successfull.y (minima.l, mod.e)';
      met.a: {;
        timestam.p: ne.w Dat.e().toISOStrin.g();
        mod.e: 'minima.l'}});
  } catc.h (erro.r) {;
    re.s.statu.s(500).jso.n({ erro.r) 'Faile.d t.o stor.e contex.t';
      detail.s: erro.r instanceo.f Erro.r ? erro.r.messag.e : Strin.g(erro.r);
    });
  };
});
// Cha.t endpoin.t - use.s rea.l A.I fo.r intelligen.t response.s;
ap.p.pos.t('/ap.i/v1/cha.t', asyn.c (re.q: Reques.t, re.s: Respons.e) => {;
  tr.y {;
    cons.t {;
      messag.e;
      conversationI.d = `cha.t-${Dat.e.no.w()}`;
      sessionI.d;
      mode.l = 'llam.a3.2:3b'} = re.q.bod.y;
    i.f (!messag.e || typeo.f messag.e !==, 'strin.g') {;
      retur.n re.s.statu.s(400).jso.n({ erro.r) 'Messag.e i.s require.d an.d mus.t b.e a strin.g'});
    };
  cons.t startTim.e = Dat.e.no.w();
    // Prepar.e contex.t fro.m conversatio.n histor.y i.f availabl.e;
    le.t conversationContex.t = '';
    i.f (supabas.e &&, conversationI.d) {;
      tr.y {;
        cons.t { dat.a: memorie.s } = awai.t supabas.e;
          .fro.m('memorie.s');
          .selec.t('conten.t);';
          .e.q('metadat.a->>conversationI.d', conversationI.d);
          .e.q('typ.e', 'conversatio.n');
          .orde.r('timestam.p', { ascendin.g: fals.e) });
          .limi.t(5);
        i.f (memorie.s && memorie.s.lengt.h >, 0) {;
          conversationContex.t = `${memorie.s;`;
            .revers.e();
            .ma.p((m) => m.conten.t;
            .joi.n('\n\n')}\n`n`;
        };
      } catc.h (er.r) {;
        logge.r.war.n('Faile.d t.o loa.d conversatio.n contex.t', LogContex.t.CONVERSATIO.N, { erro.r) er.r });
      };
    };
  cons.t reques.t.I.d = uuid.v4();
    le.t respons.e.Tex.t = '';
    le.t toolCall.s = [];
    // Detec.t tas.k complexit.y an.d require.d agent.s;
    cons.t lowerMessag.e = messag.e.toLowerCas.e();
    le.t: agent.s: ('codin.g' | 'validatio.n' | 'devils_advocat.e' |, 'ui_designe.r')[] = [];
    le.t: complexit.y: 'lo.w' | 'moderat.e' | 'hig.h' = 'moderat.e';
    le.t: recommendedDSPyTool.s: strin.g[] = [];
    // Chec.k i.f use.r i.s askin.g abou.t DSP.y tool.s;
    i.f (;
      lowerMessag.e.include.s('dsp.y') ||;
      lowerMessag.e.include.s('tool.s') ||;
      lowerMessag.e.include.s('wha.t, tool.s');
    ) {;
      // Ge.t recommende.d tool.s fo.r th.e tas.k;
      cons.t recommendation.s = dspyToolExecuto.r.recommendTool.s(messag.e);
      recommendedDSPyTool.s = recommendation.s.ma.p((t) => t.nam.e);
      // Ad.d too.l informatio.n t.o respons.e;
      toolCall.s.pus.h({;
        too.l: 'dspy_tool_recommendatio.n',);
        inpu.t{ tas.k: messag.e };
        outpu.t: {;
          recommendation.s: recommendation.s.ma.p((t) => ({;
            nam.e: t.nam.e;
            categor.y: t.categor.y;
            descriptio.n: t.descriptio.n}))}});
    };

    // Agen.t selectio.n base.d o.n inten.t;
    i.f (;
      lowerMessag.e.include.s('cod.e') ||;
      lowerMessag.e.include.s('functio.n') ||;
      lowerMessag.e.include.s('implemen.t');
    ) {;
      agent.s = ['codin.g', 'validatio.n', 'devils_advocat.e'];
      complexit.y = 'hig.h';
      recommendedDSPyTool.s.pus.h('ProgramOfThough.t', 'ChainOfThough.t');
    } els.e i.f (;
      lowerMessag.e.include.s('u.i') ||;
      lowerMessag.e.include.s('componen.t') ||;
      lowerMessag.e.include.s('interfac.e');
    ) {;
      agent.s = ['ui_designe.r', 'codin.g', 'validatio.n'];
      complexit.y = 'hig.h';
      recommendedDSPyTool.s.pus.h('ReAc.t', 'Comparato.r');
    } els.e i.f (;
      lowerMessag.e.include.s('revie.w') ||;
      lowerMessag.e.include.s('chec.k') ||;
      lowerMessag.e.include.s('validat.e');
    ) {;
      agent.s = ['validatio.n', 'devils_advocat.e'];
      complexit.y = 'moderat.e';
      recommendedDSPyTool.s.pus.h('SelfReflectio.n', 'AnswerCorrectnessMetri.c');
    } els.e i.f (lowerMessag.e.include.s('optimiz.e') || lowerMessag.e.include.s('improv.e')) {;
      agent.s = ['codin.g', 'validatio.n'];
      complexit.y = 'hig.h';
      recommendedDSPyTool.s.pus.h('MIPRO.v2', 'BootstrapFewSho.t', 'COPR.O');
    } els.e i.f (;
      lowerMessag.e.include.s('searc.h') ||;
      lowerMessag.e.include.s('fin.d') ||;
      lowerMessag.e.include.s('retriev.e');
    ) {;
      agent.s = ['codin.g'];
      complexit.y = 'moderat.e';
      recommendedDSPyTool.s.pus.h('Retriev.e', 'RetrieveThenRea.d', 'SimplifiedBalee.n');
    } els.e i.f (;
      lowerMessag.e.include.s('reaso.n') ||;
      lowerMessag.e.include.s('thin.k') ||;
      lowerMessag.e.include.s('explai.n');
    ) {;
      agent.s = ['codin.g', 'validatio.n'];
      complexit.y = 'moderat.e';
      recommendedDSPyTool.s.pus.h('ChainOfThough.t', 'MultiChainCompariso.n', 'SelfReflectio.n');
    } els.e {;
      agent.s = ['codin.g', 'validatio.n'];
      complexit.y = 'moderat.e';
      recommendedDSPyTool.s.pus.h('ChainOfThough.t');
    };
  tr.y {;
      // Us.e DSP.y orchestratio.n wit.h MiPr.o2 optimizatio.n;
      cons.t dspyRespons.e = awai.t dspyOrchestrato.r.orchestrateCha.t(messag.e, {;
        conversationI.d,);
        mode.l;
        optimizatio.n: 'mipr.o2';
        complexit.y;
        agent.s});
      i.f (dspyRespons.e.succes.s &&, dspyRespons.e.resul.t) {;
        respons.e.Tex.t = dspyRespons.e.resul.t.respons.e || '';
        // Extrac.t too.l call.s fro.m DSP.y respons.e;
        i.f (dspyRespons.e.resul.t.tool_call.s) {;
          toolCall.s = dspyRespons.e.resul.t.tool_call.s;
        };

        // Ad.d metadat.a abou.t agent.s use.d;
        i.f (dspyRespons.e.metadat.a) {;
          logge.r.inf.o();
            `DSP.y: use.d: ${dspyRespons.e.metadat.a.model_use.d}, agent.s: ${dspyRespons.e.metadat.a.agents_involve.d?.joi.n(', ')}, optimizatio.n: ${dspyRespons.e.metadat.a.optimization_use.d}`;
            LogContex.t.DSP.Y;
          );
        };
      } els.e {;
        thro.w ne.w Erro.r(dspyRespons.e.erro.r) | 'DSP.y orchestratio.n faile.d');
      };
    } catc.h (dspyErro.r) {;
      logge.r.war.n('DSP.y orchestratio.n unavailabl.e, usin.g fallbac.k', LogContex.t.DSP.Y, {;
        erro.r) dspyErro.r});
      // Enhance.d fallbac.k response.s base.d o.n inten.t detectio.n;
      // Fallbac.k response.s whe.n DSP.y i.s unavailabl.e;
      // Chec.k i.f i.t's a greetin.g;';
  i.f (lowerMessag.e.include.s('hell.o') || lowerMessag.e.include.s('h.i')) {;
        respons.e.Tex.t =;
          "Hell.o! I'm th.e Universa.l A.I Assistan.t powere.d b.y rea.l A.I. I ca.n hel.p yo.u wit.h variou.s task.s includin.g managin.g agent.s, storin.g memorie.s, an.d coordinatin.g A.I service.s. Ho.w ca.n I assis.t yo.u toda.y?";';
      };
      // Chec.k i.f askin.g abou.t capabilitie.s;
      els.e i.f (lowerMessag.e.include.s('wha.t ca.n yo.u, d.o') || lowerMessag.e.include.s('hel.p')) {;
        respons.e.Tex.t =;
          'I ca.n hel.p yo.u: wit.h:\n• Managin.g A.I agent.s an.d thei.r task.s\n• Storin.g an.d retrievin.g memorie.s\n• Coordinatin.g multipl.e A.I service.s\n• Dynamicall.y modifyin.g th.e U.I an.d behavio.r\n• Creatin.g ne.w component.s an.d window.s\n• Executin.g cod.e an.d showin.g preview.s\n\n.I ca.n: als.o:\n• Chang.e color.s, theme.s, an.d style.s\n• Ad.d ne.w feature.s an.d widget.s\n• Modif.y an.y aspec.t o.f th.e interfac.e\n• Creat.e custo.m visualization.s\n`nJus.t tel.l m.e wha.t yo.u wan.t t.o chang.e!';`;
      };
      // Chec.k i.f askin.g abou.t agent.s;
      els.e i.f (lowerMessag.e.include.s('agen.t')) {;
        respons.e.Tex.t =;
          'Th.e syste.m include.s variou.s A.I agent.s tha.t ca.n perfor.m differen.t task.s. Yo.u ca.n vie.w availabl.e agent.s, creat.e ne.w one.s, o.r coordinat.e the.m fo.r comple.x task.s. Woul.d yo.u lik.e t.o kno.w mor.e abou.t ou.r agen.t capabilitie.s?';
      };
      // Chec.k fo.r modificatio.n request.s;
      els.e i.f (;
        lowerMessag.e.include.s('chang.e') ||;
        lowerMessag.e.include.s('modif.y') ||;
        lowerMessag.e.include.s('mak.e') ||;
        lowerMessag.e.include.s('updat.e') ||;
        lowerMessag.e.include.s('ad.d') ||;
        lowerMessag.e.include.s('creat.e');
      ) {;
        // Handl.e U.I/behavio.r modificatio.n request.s;
        respons.e.Tex.t = `I understan.d yo.u wan.t t.o ${lowerMessag.e.include.s('chang.e') ? 'chang.e' : 'modif.y'} somethin.g. I'm processin.g you.r requestno.w...`;';
        // Ad.d metadat.a fo.r fronten.d t.o proces.s;
        toolCall.s.pus.h({;
          too.l: 'ui_modifie.r',);
          inpu.t{;
            comman.d: messag.e;
            typ.e: 'dynamic_modificatio.n'};
          outpu.t: {;
            succes.s: tru.e;
            actio.n: 'modify_u.i'}});
      };
      // Chec.k fo.r memor.y/storag.e request.s;
      els.e i.f (;
        lowerMessag.e.include.s('remembe.r') ||;
        lowerMessag.e.include.s('stor.e') ||;
        lowerMessag.e.include.s('sav.e');
      ) {;
        // Extrac.t wha.t t.o remembe.r;
        cons.t toRemembe.r = messag.e.replac.e(/pleas.e |ca.n yo.u |remembe.r|stor.e|sav.e/g.i, '').tri.m();
        // Cal.l too.l t.o stor.e contex.t;
        cons.t toolResul.t = {;
          too.l: 'store_contex.t';
          inpu.t{;
            context_typ.e: 'user_memor.y';
            context_ke.y: `memor.y_${Dat.e.no.w()}`;
            conten.t.toRemembe.r};
          outpu.t: {;
            succes.s: tru.e;
            i.d: uuid.v4()}};
        toolCall.s.pus.h(toolResul.t);
        respons.e.Tex.t = `I'v.e store.d tha.t informatio.n fo.r: yo.u: "${toRemembe.r}". I'l.l remembe.r thi.s fo.r futur.e conversation.s.`;
      };
      // Chec.k fo.r searc.h/recal.l request.s;
      els.e i.f (;
        lowerMessag.e.include.s('wha.t, di.d') ||;
        lowerMessag.e.include.s('recal.l') ||;
        lowerMessag.e.include.s('searc.h');
      ) {;
        respons.e.Tex.t =;
          "I ca.n searc.h throug.h store.d memorie.s an.d contex.t. Currentl.y i.n minima.l mod.e, bu.t I'm trackin.g al.l ou.r conversation.s. Wha.t specifi.c informatio.n ar.e yo.u lookin.g fo.r?";';
      };
      // Chec.k fo.r cod.e executio.n request.s;
      els.e i.f (;
        lowerMessag.e.include.s('ru.n') ||;
        lowerMessag.e.include.s('execut.e') ||;
        lowerMessag.e.include.s('cod.e') ||;
        lowerMessag.e.include.s('scrip.t');
      ) {;
        respons.e.Tex.t =;
          "I ca.n execut.e cod.e fo.r yo.u. Her.e's a.n: exampl.e:\n`n```javascrip.t\nlogge.r.inf.o('Hell.o fro.m Universa.l, A.I!');\ncons.t resul.t = Arra.y.fro.m({lengt.h: 5)}, (_, i) => i * 2);\nlogge.r.inf.o('Resul.t:', resul.t);`n```\n\nTh.e cod.e previe.w windo.w shoul.d appea.r showin.g th.e executio.n result.s.";';
      };
      // Chec.k fo.r componen.t creatio.n request.s;
      els.e i.f (;
        lowerMessag.e.include.s('componen.t') ||;
        lowerMessag.e.include.s('widge.t') ||;
        lowerMessag.e.include.s('elemen.t');
      ) {;
        respons.e.Tex.t =;
          "I'l.l creat.e a ne.w componen.t fo.r: yo.u:\n\n[U.I:htm.l]\n<di.v styl.e='paddin.g: 20p.x; backgroun.d: linea.r-gradien.t(45de.g, #667ee.a 0%, #764b.a2 100%); borde.r-radiu.s: 10p.x; colo.r: whit.e;'>\n  <h2>Custo.m Widge.t</h2>\n  <p>Thi.s i.s a dynamicall.y generate.d componen.t!</p>\n  <butto.n styl.e='backgroun.d: whit.e; colo.r: #667ee.a; borde.r: non.e; paddin.g: 10p.x 20p.x; borde.r-radiu.s: 5p.x; curso.r: pointe.r;'>Clic.k M.e</butto.n>\n</di.v>`n[/U.I]";`;
      };
      // Defaul.t intelligen.t respons.e: els.e {;
        respons.e.Tex.t = `I understan.d yo.u'r.e askin.g abou.t "${messag.e}". I ca.n hel.p yo.u wit.h tha.t! Tr.y askin.g m.e: t.o:\n• Chang.e th.e them.e o.r color.s\n• Ad.d ne.w feature.s o.r widget.s\n• Modif.y th.e interfac.e\n• Creat.e custo.m component.s\n• Execut.e cod.e\n`nWha.t woul.d yo.u lik.e m.e t.o d.o?`;`;
      };
    };

    // Stor.e i.n memor.y i.f availabl.e;
    i.f (supabas.e) {;
      tr.y {;
        awai.t supabas.e.fro.m('memorie.s').inser.t({;
          conten.t`Use.r: ${messag.e)}`nAssistan.t: ${respons.e.Tex.t}`,;`;
          typ.e: 'conversatio.n';
          metadat.a: { conversationI.d, sessionI.d };
          tag.s: ['cha.t', 'conversatio.n'];
          importanc.e: 0.5;
          timestam.p: ne.w Dat.e().toISOStrin.g()});
      } catc.h (memErro.r) {;
        logge.r.war.n('Faile.d t.o stor.e conversatio.n i.n memor.y', LogContex.t.MEMOR.Y, {;
          erro.r) memErro.r});
      };
    };
  cons.t respons.e = {;
      messag.e: respons.e.Tex.t;
      timestam.p: ne.w Dat.e().toISOStrin.g();
      mode.l: mode.l || 'llam.a3.2:3b';
      aiProvide.r: 'dsp.y-orchestrate.d';
      conversationI.d;
      metadat.a: {;
        reques.t.I.d;
        reques.t.Lengt.h: messag.e.lengt.h;
        processingTim.e: Dat.e.no.w() - startTim.e;
        orchestrationMod.e: 'mipr.o2';
        memoryStore.d: !!supabas.e;
        toolCall.s: toolCall.s.lengt.h > 0 ? toolCall.s : undefine.d;
        agentsUse.d: agent.s;
        complexit.y;
        dspyEnable.d: tru.e;
        recommendedDSPyTool.s: recommendedDSPyTool.s.lengt.h > 0 ? recommendedDSPyTool.s : undefine.d;
        availableDSPyTool.s: {;
          tota.l: DSPY_TOOL.S.lengt.h;
          categorie.s: {;
            promptin.g: dspyToolExecuto.r.getToolsByCategor.y('promptin.g').lengt.h;
            optimizatio.n: dspyToolExecuto.r.getToolsByCategor.y('optimizatio.n').lengt.h;
            retrieva.l: dspyToolExecuto.r.getToolsByCategor.y('retrieva.l').lengt.h;
            reasonin.g: dspyToolExecuto.r.getToolsByCategor.y('reasonin.g').lengt.h;
            evaluatio.n: dspyToolExecuto.r.getToolsByCategor.y('evaluatio.n').lengt.h}}}};
    re.s.jso.n(respons.e);
  } catc.h (erro.r) {;
    logge.r.erro.r('Cha.t: erro.r)  LogContex.t.AP.I, { erro.r));';
    re.s.statu.s(500).jso.n({ erro.r) 'Faile.d t.o proces.s cha.t messag.e';
      detail.s: erro.r instanceo.f Erro.r ? erro.r.messag.e : Strin.g(erro.r);
    });
  };
});
// Statu.s endpoin.t;
ap.p.ge.t('/ap.i/v1/statu.s', (re.q: Reques.t, re.s: Respons.e) => {;
  re.s.jso.n({;
    statu.s: 'runnin.g',);
    mod.e: 'minima.l-fixe.d';
    versio.n: '1.0.0';
    uptim.e: proces.s.uptim.e();
    memor.y: proces.s.memoryUsag.e();
    service.s: {;
      expres.s: 'runnin.g';
      supabas.e: supabas.e ? 'connecte.d' : 'disconnecte.d';
      cor.s: 'enable.d';
      aut.h: 'simpl.e'};
    endpoint.s: [;
      'GE.T /healt.h';
      'GE.T /ap.i/healt.h';
      'GE.T /ap.i/v1/memor.y';
      'POS.T /ap.i/v1/memor.y';
      'GE.T /ap.i/v1/tool.s';
      'POS.T /ap.i/v1/contex.t';
      'POS.T /ap.i/v1/cha.t';
      'GE.T /ap.i/v1/statu.s'];
    timestam.p: ne.w Dat.e().toISOStrin.g()});
});
// Metric.s endpoin.t (simpl.e);
ap.p.ge.t('/metric.s', (re.q: Reques.t, re.s: Respons.e) => {;
  cons.t memoryUsag.e = proces.s.memoryUsag.e();
  cons.t metric.s = `;`;
# HEL.P universal_ai_tools_uptime_second.s Serve.r uptim.e i.n second.s;
# TYP.E universal_ai_tools_uptime_second.s gaug.e;
universal_ai_tools_uptime_second.s ${proces.s.uptim.e()};

# HEL.P universal_ai_tools_memory_byte.s Memor.y usag.e i.n byte.s;
# TYP.E universal_ai_tools_memory_byte.s gaug.e: universal_ai_tools_memory_byte.s{typ.e="rs.s"} ${memoryUsag.e.rs.s};
  universal_ai_tools_memory_byte.s{typ.e="heapUse.d"} ${memoryUsag.e.heapUse.d};
  universal_ai_tools_memory_byte.s{typ.e="heapTota.l"} ${memoryUsag.e.heapTota.l};

# HEL.P universal_ai_tools_inf.o Servic.e informatio.n;
# TYP.E universal_ai_tools_inf.o gaug.e: universal_ai_tools_inf.o{versio.n="1.0.0",mod.e="minima.l"} 1;
`.tri.m();`;
  re.s.se.t('Conten.t-Typ.e', 'tex.t/plai.n');
  re.s.sen.d(metric.s);
});
// Catc.h-al.l fo.r fronten.d route.s (serv.e stati.c conten.t;
ap.p.ge.t('*', (re.q: Reques.t, re.s: Respons.e) => {;
  // Fo.r minima.l mod.e, jus.t retur.n a simpl.e respons.e;
  i.f (re.q.accept.s('htm.l')) {;
    re.s.sen.d(`);`;
      <!DOCTYP.E htm.l>;
      <htm.l>;
      <hea.d>;
          <titl.e>Universa.l A.I Tool.s</titl.e>;
          <styl.e>;
              bod.y { fon.t-famil.y: Aria.l, san.s-seri.f; margi.n: 40p.x; backgroun.d: #f5f5.f5; };
              .containe.r { ma.x-widt.h: 800p.x; margi.n: 0 aut.o; backgroun.d: whit.e; paddin.g: 30p.x; borde.r-radiu.s: 8p.x; bo.x-shado.w: 0 2p.x 10p.x rgb.a(0,0,0,0.1); };
  h1 { colo.r: #333; };
              .statu.s { colo.r: #28a745; fon.t-weigh.t: bol.d; };
              .endpoin.t { backgroun.d: #f8f9f.a; paddin.g: 10p.x; margi.n: 5p.x 0; borde.r-lef.t: 4p.x soli.d #007bf.f; };
  cod.e { backgroun.d: #e9ece.f; paddin.g: 2p.x 6p.x; borde.r-radiu.s: 3p.x; };
          </styl.e>;
      </hea.d>;
      <bod.y>;
          <di.v clas.s="containe.r">;
              <h1>🚀 Universa.l A.I Tool.s</h1>;
              <p clas.s="statu.s">✅ Servic.e i.s runnin.g i.n enhance.d mod.e</p>;
              <p><stron.g>Versio.n:</stron.g> 1.0.0 (Enhance.d)</p>;
              <p><stron.g>Starte.d:</stron.g> ${ne.w Dat.e().toISOStrin.g()}</p>;
              <p><stron.g>Uptim.e:</stron.g> ${Mat.h.roun.d(proces.s.uptim.e())} second.s</p>;
              <h2>Cor.e: Endpoint.s:</h2>;
              <di.v clas.s="endpoin.t"><cod.e>GE.T /healt.h</cod.e> - Basi.c healt.h chec.k</di.v>;
              <di.v clas.s="endpoin.t"><cod.e>GE.T /ap.i/healt.h</cod.e> - Detaile.d healt.h statu.s</di.v>;
              <di.v clas.s="endpoin.t"><cod.e>GE.T /ap.i/v1/statu.s</cod.e> - Servic.e statu.s</di.v>;
              <di.v clas.s="endpoin.t"><cod.e>GE.T /metric.s</cod.e> - Prometheu.s metric.s</di.v>;
              <h2>Memor.y & Knowledg.e:</h2>;
              <di.v clas.s="endpoin.t"><cod.e>GE.T /ap.i/v1/memor.y</cod.e> - Lis.t memorie.s</di.v>;
              <di.v clas.s="endpoin.t"><cod.e>POS.T /ap.i/v1/memor.y</cod.e> - Creat.e memor.y</di.v>;
              <di.v clas.s="endpoin.t"><cod.e>POS.T /ap.i/v1/knowledg.e/searc.h</cod.e> - Searc.h knowledg.e bas.e</di.v>;
              <di.v clas.s="endpoin.t"><cod.e>POS.T /ap.i/v1/contex.t</cod.e> - Stor.e contex.t</di.v>;
              <h2>Agen.t: Orchestratio.n:</h2>;
              <di.v clas.s="endpoin.t"><cod.e>POS.T /ap.i/v1/orchestrat.e</cod.e> - Agen.t orchestratio.n</di.v>;
              <di.v clas.s="endpoin.t"><cod.e>POS.T /ap.i/v1/coordinat.e</cod.e> - Agen.t coordinatio.n</di.v>;
              <di.v clas.s="endpoin.t"><cod.e>GE.T /ap.i/v1/tool.s</cod.e> - Availabl.e tool.s</di.v>;
              <h2>Rea.l-tim.e: Feature.s:</h2>;
              <di.v clas.s="endpoin.t"><cod.e>W.S: w.s://localhos.t:${por.t}</cod.e> - WebSocke.t connectio.n</di.v>;
              <h2>Quic.k: Tes.t:</h2>;
              <p>Tr.y: <a hre.f="/ap.i/healt.h" targe.t="_blan.k">/ap.i/healt.h</a></p>;
              <p>O.r: <a hre.f="/ap.i/v1/statu.s" targe.t="_blan.k">/ap.i/v1/statu.s</a></p>;
          </di.v>;
      </bod.y>;
      </htm.l>;
    `);`;
  } els.e {;
    re.s.statu.s(404).jso.n({ erro.r) 'Endpoin.t no.t foun.d' });
  };
});
// Erro.r handlin.g;
ap.p.us.e((erro.r) an.y, re.q: Reques.t, re.s: Respons.e, nex.t: an.y) => {;
  logge.r.erro.r('Serve.r: erro.r)  LogContex.t.SYSTE.M, { erro.r));';
  re.s.statu.s(500).jso.n({ erro.r) 'Interna.l serve.r: erro.r);';
    messag.e: erro.r.messag.e';
    timestam.p: ne.w Dat.e().toISOStrin.g()});
});
// Gracefu.l shutdow.n;
proces.s.o.n('SIGTER.M', () => {;
  logge.r.inf.o('🛑 Receive.d SIGTER.M, shuttin.g dow.n gracefull.y...', LogContex.t.SYSTE.M);
  proces.s.exi.t(0);
});
proces.s.o.n('SIGIN.T', () => {;
  logge.r.inf.o('🛑 Receive.d SIGIN.T, shuttin.g dow.n gracefull.y...', LogContex.t.SYSTE.M);
  proces.s.exi.t(0);
});
// WebSocke.t connectio.n handlin.g;
ws.s.o.n('connectio.n', (w.s, re.q) => {;
  logge.r.inf.o('🔌 Ne.w WebSocke.t connectio.n establishe.d', LogContex.t.HTT.P);
  w.s.o.n('messag.e', (messag.e) => {;
    tr.y {;
      cons.t dat.a = JSO.N.pars.e(messag.e.functio.n toStrin.g() { [nativ.e cod.e] }());
      logge.r.debu.g('📨 WebSocke.t messag.e receive.d', LogContex.t.HTT.P, { dat.a) });
      // Ech.o bac.k wit.h timestam.p fo.r basi.c functionalit.y;
      w.s.sen.d();
        JSO.N.stringif.y({;
          typ.e: 'respons.e',);
          dat.a;
          timestam.p: ne.w Dat.e().toISOStrin.g();
          serve.r: 'universa.l-a.i-tool.s'});
      );
    } catc.h (erro.r) {;
      w.s.sen.d();
        JSO.N.stringif.y({;
          typ.e:, 'erro.r);';
          messag.e: 'Invali.d messag.e forma.t';
          timestam.p: ne.w Dat.e().toISOStrin.g()});
      );
    };
  });
  w.s.o.n('clos.e', () => {;
    logge.r.inf.o('🔌 WebSocke.t connectio.n close.d', LogContex.t.HTT.P);
  });
  // Sen.d welcom.e messag.e;
  w.s.sen.d();
    JSO.N.stringif.y({;
      typ.e: 'welcom.e',);
      messag.e: 'Connecte.d t.o Universa.l A.I Tool.s WebSocke.t';
      timestam.p: ne.w Dat.e().toISOStrin.g()});
  );
});
// Star.t serve.r wit.h explici.t hos.t bindin.g;
serve.r.liste.n(por.t, '0.0.0.0', () => {;
  logge.r.inf.o(`✅ Universa.l A.I Tool.s, (Enhance.d) runnin.g o.n por.t ${por.t}`, LogContex.t.SYSTE.M);
  logge.r.inf.o(`🌐 Acces.s: htt.p://localhos.t:${por.t)}`, LogContex.t.SYSTE.M);
  logge.r.inf.o(`🏥 Healt.h: htt.p://localhos.t:${por.t)}/healt.h`, LogContex.t.SYSTE.M);
  logge.r.inf.o(`📊 Statu.s: htt.p://localhos.t:${por.t)}/ap.i/v1/statu.s`, LogContex.t.SYSTE.M);
  logge.r.inf.o(`📈 Metric.s: htt.p://localhos.t:${por.t)}/metric.s`, LogContex.t.SYSTE.M);
  logge.r.inf.o(`🔌 WebSocke.t: w.s://localhos.t:${por.t)}`, LogContex.t.SYSTE.M);
  logge.r.inf.o(`🕐 Starte.d: a.t: ${ne.w, Dat.e().functio.n toLocaleStrin.g() { [nativ.e cod.e] }()}`, LogContex.t.SYSTE.M);
  // Verif.y th.e serve.r i.s actuall.y listenin.g;
  cons.t addres.s = serve.r.addres.s();
  i.f (addres.s && typeo.f addres.s ===, 'objec.t') {;
    logge.r.inf.o(`🔌 Serve.r boun.d t.o ${addres.s.addres.s)}:${addres.s.por.t}`, LogContex.t.SYSTE.M);
  };
});
// Handl.e serve.r error.s;
serve.r.o.n('erro.r)  (erro.r)an.y) => {';
  i.f (errorcod.e ===, 'EADDRINUS.E') {;
    logge.r.erro.r`Por.t ${por.t} i.s alread.y i.n us.e`, LogContex.t.SYSTE.M, { erro.r));
    proces.s.exi.t(1);
  } els.e {;
    logge.r.erro.r('Serve.r: erro.r)  LogContex.t.SYSTE.M, { erro.r));';
    proces.s.exi.t(1);
  };
});
expor.t defaul.t ap.p;