<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ollama AI SQL Assistant Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 30px; }
        textarea {
            width: 100%;
            min-height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 16px;
        }
        button:hover { background: #0052a3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result {
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Consolas', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .error { background: #fee; border-color: #fcc; color: #c00; }
        .success { background: #efe; border-color: #cfc; }
        .status { 
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .examples {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .example {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .example:hover { background: #dee2e6; }
    </style>
</head>
<body>
    <h1>ü§ñ Ollama AI SQL Assistant Test</h1>
    
    <div class="container">
        <h2>Connection Status</h2>
        <div id="status" class="status disconnected">Checking connection...</div>
        <button onclick="checkConnection()">Refresh Status</button>
    </div>

    <div class="container">
        <h2>Generate SQL</h2>
        <textarea id="generatePrompt" placeholder="Example: find all users who logged in today">find all active users created in the last 30 days</textarea>
        <div class="examples">
            <div class="example" onclick="setPrompt('generate', 'show all tables in the database')">Show all tables</div>
            <div class="example" onclick="setPrompt('generate', 'find users who have placed orders totaling over $1000')">High-value customers</div>
            <div class="example" onclick="setPrompt('generate', 'count unique visitors by day for the last week')">Daily visitors</div>
        </div>
        <br><br>
        <button onclick="generateSQL()">Generate SQL</button>
        <div id="generateResult"></div>
    </div>

    <div class="container">
        <h2>Explain SQL</h2>
        <textarea id="explainQuery" placeholder="Paste SQL query to explain">SELECT u.name, COUNT(o.id) as order_count, SUM(o.total) as total_spent
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.created_at > NOW() - INTERVAL '30 days'
GROUP BY u.id, u.name
HAVING COUNT(o.id) > 0
ORDER BY total_spent DESC;</textarea>
        <br><br>
        <button onclick="explainSQL()">Explain Query</button>
        <div id="explainResult"></div>
    </div>

    <div class="container">
        <h2>Optimize SQL</h2>
        <textarea id="optimizeQuery" placeholder="Paste SQL query to optimize">SELECT * FROM orders WHERE user_id IN (SELECT id FROM users WHERE email LIKE '%@gmail.com')</textarea>
        <br><br>
        <button onclick="optimizeSQL()">Optimize Query</button>
        <div id="optimizeResult"></div>
    </div>

    <script>
        const OLLAMA_URL = 'http://localhost:8080';
        
        async function checkConnection() {
            const statusEl = document.getElementById('status');
            try {
                const response = await fetch(`${OLLAMA_URL}/api/tags`);
                const data = await response.json();
                statusEl.className = 'status connected';
                statusEl.textContent = `‚úÖ Connected to Ollama (${data.models?.length || 0} models available)`;
            } catch (error) {
                statusEl.className = 'status disconnected';
                statusEl.textContent = '‚ùå Cannot connect to Ollama. Make sure nginx proxy is running.';
            }
        }

        async function callOllama(prompt, model = 'llama3.2:3b') {
            const response = await fetch(`${OLLAMA_URL}/api/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model,
                    prompt,
                    stream: false,
                    temperature: 0.1
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            return data.response;
        }

        async function generateSQL() {
            const prompt = document.getElementById('generatePrompt').value;
            const resultEl = document.getElementById('generateResult');
            
            if (!prompt.trim()) {
                resultEl.innerHTML = '<div class="result error">Please enter a prompt</div>';
                return;
            }
            
            resultEl.innerHTML = '<div class="result">Generating SQL...</div>';
            
            try {
                const fullPrompt = `You are a PostgreSQL expert. Generate only SQL code for this request, no explanations or markdown: ${prompt}`;
                const result = await callOllama(fullPrompt);
                
                // Clean up the response
                const sql = result.replace(/```sql\n?/gi, '').replace(/```\n?/gi, '').trim();
                
                resultEl.innerHTML = `<div class="result success">${sql}</div>`;
            } catch (error) {
                resultEl.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function explainSQL() {
            const query = document.getElementById('explainQuery').value;
            const resultEl = document.getElementById('explainResult');
            
            if (!query.trim()) {
                resultEl.innerHTML = '<div class="result error">Please enter a SQL query</div>';
                return;
            }
            
            resultEl.innerHTML = '<div class="result">Analyzing query...</div>';
            
            try {
                const fullPrompt = `Explain this PostgreSQL query in simple terms: ${query}`;
                const result = await callOllama(fullPrompt, 'llama3.2:3b');
                
                resultEl.innerHTML = `<div class="result success">${result}</div>`;
            } catch (error) {
                resultEl.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function optimizeSQL() {
            const query = document.getElementById('optimizeQuery').value;
            const resultEl = document.getElementById('optimizeResult');
            
            if (!query.trim()) {
                resultEl.innerHTML = '<div class="result error">Please enter a SQL query</div>';
                return;
            }
            
            resultEl.innerHTML = '<div class="result">Optimizing query...</div>';
            
            try {
                const fullPrompt = `Optimize this PostgreSQL query for better performance. Return only the optimized SQL code: ${query}`;
                const result = await callOllama(fullPrompt);
                
                // Clean up the response
                const sql = result.replace(/```sql\n?/gi, '').replace(/```\n?/gi, '').trim();
                
                resultEl.innerHTML = `<div class="result success">${sql}</div>`;
            } catch (error) {
                resultEl.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        function setPrompt(type, text) {
            if (type === 'generate') {
                document.getElementById('generatePrompt').value = text;
            }
        }

        // Check connection on load
        window.onload = checkConnection;
    </script>
</body>
</html>