#!/bin/sh
# Pre-commit hook for Universal AI Tools
# Ensures code quality before each commit

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we have staged TypeScript files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$')

if [ -z "$STAGED_TS_FILES" ]; then
  echo "‚úÖ No TypeScript files to check"
  exit 0
fi

echo "üìù Checking TypeScript files..."

# Function to check a single file
check_file() {
  local file=$1
  local errors=0
  
  # Check if file exists
  if [ ! -f "$file" ]; then
    return 0
  fi
  
  # Run TypeScript compiler on the file
  echo -n "  Checking $file... "
  npx tsc --noEmit --skipLibCheck "$file" 2>/tmp/tsc-errors.log
  
  if [ $? -ne 0 ]; then
    echo "${RED}‚ùå TypeScript errors${NC}"
    cat /tmp/tsc-errors.log | head -10
    errors=$((errors + 1))
  else
    echo "${GREEN}‚úÖ${NC}"
  fi
  
  # Run ESLint
  npx eslint "$file" --quiet 2>/tmp/eslint-errors.log
  
  if [ $? -ne 0 ]; then
    echo "  ${RED}‚ùå ESLint errors in $file${NC}"
    cat /tmp/eslint-errors.log | head -5
    errors=$((errors + 1))
  fi
  
  # Check for TODO/FIXME comments
  if grep -E "(TODO|FIXME|HACK|BUG):" "$file" > /dev/null; then
    echo "  ${YELLOW}‚ö†Ô∏è  Found TODO/FIXME comments in $file${NC}"
    grep -n -E "(TODO|FIXME|HACK|BUG):" "$file" | head -3
  fi
  
  return $errors
}

# Check each staged file
total_errors=0
for file in $STAGED_TS_FILES; do
  check_file "$file"
  total_errors=$((total_errors + $?))
done

# Run Prettier on staged files
echo ""
echo "üé® Running Prettier..."
npx prettier --check $STAGED_TS_FILES > /dev/null 2>&1

if [ $? -ne 0 ]; then
  echo "${YELLOW}‚ö†Ô∏è  Some files need formatting${NC}"
  echo "Running Prettier fix..."
  npx prettier --write $STAGED_TS_FILES
  
  # Re-add the formatted files
  for file in $STAGED_TS_FILES; do
    git add "$file"
  done
  echo "${GREEN}‚úÖ Files formatted${NC}"
fi

# Final check
if [ $total_errors -gt 0 ]; then
  echo ""
  echo "${RED}‚ùå Pre-commit checks failed!${NC}"
  echo "Please fix the errors above before committing."
  echo ""
  echo "Tips:"
  echo "  - Run 'npm run lint:fix' to auto-fix some issues"
  echo "  - Run 'npm run build' to see all TypeScript errors"
  echo "  - Use 'git commit --no-verify' to skip these checks (not recommended)"
  exit 1
fi

echo ""
echo "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
