# 🤖 Ollama-Powered Database Management

## Overview

Your Supabase database is now powered by Ollama AI, enabling intelligent database management, automatic table creation, and smart repairs.

## Available Tools

### 1. **Database Manager** (`npm run db:manager`)
Interactive CLI for comprehensive database management:
- 🏥 Health checks
- 🔧 Auto-fix issues
- 🚀 Optimization suggestions
- 📋 Custom table creation
- 🧹 Data cleanup
- 📊 Report generation

### 2. **Auto-Fix** (`npm run db:autofix`)
Automatically detects and fixes common issues:
- Creates missing essential tables
- Generates proper schemas using Ollama
- Sets up indexes and policies
- Adds sample data where appropriate

### 3. **Health Check** (`npm run db:health`)
Quick database health assessment

## How It Works

### Intelligent Table Creation
When a table is missing, Ollama:
1. Analyzes the table's purpose and requirements
2. Generates optimized PostgreSQL schema
3. Includes proper data types, constraints, and indexes
4. Adds Row Level Security (RLS) policies
5. Creates sample data if requested

### Example: Creating the `memories` table
```sql
-- Generated by Ollama (qwen2.5:7b)
CREATE TABLE IF NOT EXISTS memories (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  content TEXT,
  metadata JSONB,
  user_id UUID,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE memories ENABLE ROW LEVEL SECURITY;
-- Policies and indexes included...
```

## Essential Tables

The system maintains these core tables:

### 1. **ai_memories**
- Stores AI agent memories and context
- Used by the autofix system
- Includes metadata for learning patterns

### 2. **memories** (legacy)
- Backward compatibility table
- Simple memory storage

### 3. **agent_tools**
- Available tools and functions for AI agents
- Includes parameters and enable/disable flags

### 4. **agent_sessions**
- Tracks AI agent sessions
- Stores conversation context

## Ollama AI Functions

Three SQL functions integrate directly with Ollama:

```sql
-- Generate SQL from natural language
SELECT ai_generate_sql('find all users created this week');

-- Explain complex queries
SELECT ai_explain_sql('SELECT * FROM users u JOIN orders o ON u.id = o.user_id');

-- Optimize queries
SELECT ai_optimize_sql('SELECT * FROM large_table WHERE status = ''active''');
```

## Common Tasks

### Fix All Database Issues
```bash
npm run db:autofix
```
This will:
- Check all essential tables
- Create missing ones with proper schemas
- Set up Ollama AI functions
- Apply migrations

### Interactive Management
```bash
npm run db:manager
```
Menu options:
- Health check
- Fix issues
- Optimize database
- Create custom tables
- Clean data
- Generate reports

### Check Specific Table
```javascript
// In db:manager, choose "Create custom table"
Table name: user_preferences
Purpose: Store user settings and preferences per user
```

Ollama will generate a complete schema with:
- Proper columns based on purpose
- Indexes for performance
- RLS policies for security
- Foreign key constraints if needed

## Best Practices

### 1. **Review Generated SQL**
Always review Ollama's generated SQL before applying:
- Check data types are appropriate
- Verify indexes make sense
- Ensure policies match your security model

### 2. **Use Appropriate Models**
- `llama3.2:3b` - Fast, good for simple schemas
- `qwen2.5:7b` - Better for complex tables
- `deepseek-r1:14b` - Best quality, use for critical tables

### 3. **Backup Before Major Changes**
```bash
# Export current schema
pg_dump $DATABASE_URL --schema-only > backup.sql
```

### 4. **Test Migrations Locally**
All generated migrations are saved to `supabase/migrations/`
Review and test before deploying to production.

## Troubleshooting

### Ollama Not Responding
```bash
# Check if running
curl http://localhost:11434/api/tags

# Restart if needed
ollama serve
```

### Migration Errors
1. Check the migration file in `supabase/migrations/`
2. Fix any syntax errors
3. Re-run: `npx supabase db reset`

### Table Already Exists
The system checks for existing tables, but if you get conflicts:
1. Drop the table manually
2. Re-run the auto-fix

## Advanced Usage

### Custom Optimization
```bash
npm run db:manager
# Choose "Optimize database"
```
Ollama will analyze your tables and suggest:
- Missing indexes
- Query optimizations
- Schema improvements

### Batch Table Creation
Create multiple related tables at once:
```bash
# In db:manager
Table name: ecommerce_system
Purpose: Complete e-commerce system with products, orders, customers, inventory
```

Ollama will generate a comprehensive schema with all related tables.

## Summary

With Ollama integration, your Supabase database becomes self-healing and intelligent:
- 🤖 **AI-Generated Schemas**: Optimal table structures
- 🔧 **Auto-Repair**: Fixes issues automatically  
- 🚀 **Optimization**: Performance improvements
- 📊 **Smart Analysis**: Intelligent suggestions

The system combines Ollama's language understanding with PostgreSQL best practices to maintain a healthy, optimized database!