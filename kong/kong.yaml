# Kong API Gateway Configuration
# Provides centralized routing, authentication, and rate limiting
_format_version: "3.0"

services:
  # Node.js Backend Service
  - name: node-backend
    url: http://node-backend:9999
    plugins:
      - name: rate-limiting
        config:
          minute: 1000
          hour: 10000
          policy: local
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
            - Authorization
          exposed_headers:
            - X-Auth-Token
          credentials: true
          max_age: 3600
    routes:
      - name: api-routes
        paths:
          - "/api"
        strip_path: false
        preserve_host: true

  # Message Broker Service
  - name: message-broker
    url: http://message-broker:8080
    plugins:
      - name: rate-limiting
        config:
          minute: 500
          hour: 5000
          policy: local
    routes:
      - name: message-broker-routes
        paths:
          - "/broker"
        strip_path: true
        preserve_host: false

  # Load Balancer Service
  - name: load-balancer
    url: http://load-balancer:8081
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000
          policy: local
    routes:
      - name: load-balancer-routes
        paths:
          - "/load-balancer"
        strip_path: true

  # Cache Coordinator Service
  - name: cache-coordinator
    url: http://cache-coordinator:8083
    plugins:
      - name: rate-limiting
        config:
          minute: 1000
          hour: 10000
          policy: local
    routes:
      - name: cache-routes
        paths:
          - "/cache"
        strip_path: true

  # Stream Processor Service
  - name: stream-processor
    url: http://stream-processor:8084
    plugins:
      - name: rate-limiting
        config:
          minute: 300
          hour: 3000
          policy: local
    routes:
      - name: stream-routes
        paths:
          - "/stream"
        strip_path: true

  # ML Stream Processor Service
  - name: ml-stream-processor
    url: http://ml-stream-processor:8088
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 50
    routes:
      - name: ml-stream-routes
        paths:
          - "/ml-stream"
        strip_path: true

  # Shared Memory Service
  - name: shared-memory
    url: http://shared-memory:8089
    plugins:
      - name: rate-limiting
        config:
          minute: 500
          hour: 5000
          policy: local
    routes:
      - name: shared-memory-routes
        paths:
          - "/shared-memory"
        strip_path: true

  # Tracing Service
  - name: tracing-service
    url: http://tracing-service:8090
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000
          policy: local
    routes:
      - name: tracing-routes
        paths:
          - "/tracing"
        strip_path: true

  # Metrics Aggregator Service
  - name: metrics-aggregator
    url: http://metrics-aggregator:8091
    plugins:
      - name: rate-limiting
        config:
          minute: 300
          hour: 3000
          policy: local
    routes:
      - name: metrics-routes
        paths:
          - "/metrics"
        strip_path: true

  # Go ML Inference Service
  - name: go-ml-inference
    url: http://go-ml-inference:8086
    plugins:
      - name: rate-limiting
        config:
          minute: 50
          hour: 500
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 100
    routes:
      - name: go-ml-routes
        paths:
          - "/ml/go"
        strip_path: true

  # Rust ML Inference Service
  - name: rust-ml-inference
    url: http://rust-ml-inference:8087
    plugins:
      - name: rate-limiting
        config:
          minute: 50
          hour: 500
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 100
    routes:
      - name: rust-ml-routes
        paths:
          - "/ml/rust"
        strip_path: true

  # Rust Parameter Analytics Service
  - name: rust-parameter-analytics
    url: http://rust-parameter-analytics:8092
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000
          policy: local
    routes:
      - name: rust-analytics-routes
        paths:
          - "/analytics"
        strip_path: true

  # Rust AB-MCTS Service
  - name: rust-ab-mcts
    url: http://rust-ab-mcts:8093
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local
    routes:
      - name: rust-mcts-routes
        paths:
          - "/mcts"
        strip_path: true

  # Service Discovery
  - name: service-discovery
    url: http://service-discovery:8094
    plugins:
      - name: rate-limiting
        config:
          minute: 500
          hour: 5000
          policy: local
    routes:
      - name: discovery-routes
        paths:
          - "/discovery"
        strip_path: true

# Global Plugins
plugins:
  - name: prometheus
    config:
      per_consumer: false
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

  - name: request-id
    config:
      header_name: X-Kong-Request-ID
      generator: uuid#counter

  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: tracker
      echo_downstream: true

# Consumer Groups (for different API usage tiers)
consumer_groups:
  - name: premium-tier
    plugins:
      - name: rate-limiting
        config:
          minute: 5000
          hour: 50000
          policy: redis
          
  - name: standard-tier
    plugins:
      - name: rate-limiting
        config:
          minute: 1000
          hour: 10000
          policy: local

  - name: basic-tier
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local

# Upstream Health Checks
upstreams:
  - name: node-backend-upstream
    algorithm: round-robin
    healthchecks:
      active:
        type: http
        http_path: "/api/health"
        healthy:
          interval: 10
          successes: 3
        unhealthy:
          interval: 10
          http_failures: 3
          timeouts: 3
      passive:
        type: http
        healthy:
          successes: 3
        unhealthy:
          http_failures: 3
          timeouts: 3
    targets:
      - target: node-backend:9999
        weight: 100

  - name: ml-services-upstream
    algorithm: least-connections
    healthchecks:
      active:
        type: http
        http_path: "/health"
        healthy:
          interval: 15
          successes: 2
        unhealthy:
          interval: 15
          http_failures: 2
          timeouts: 2
    targets:
      - target: go-ml-inference:8086
        weight: 100
      - target: rust-ml-inference:8087
        weight: 100